#include "daisy_seed.h"
#include "daisysp.h"
#include "dev/mpr121.h"
#include "chebyshev.h"
#include "comb.h"
#include <bitset>

using namespace daisy;
using namespace daisysp;

Mpr121I2CTransport i2c;
Mpr121I2C touch;
DaisySeed hw;

Oscillator sines[12];
uint16_t touched;

void AudioCallback(AudioHandle::InputBuffer in, AudioHandle::OutputBuffer out, size_t size)
{
	for (size_t i = 0; i < size; i++)
	{
		out[0][i] = 0.f;
		out[1][i] = 0.f;
        if (touched > 0 ) {
            for (int j = 0; j < 12;j++) {
                out[0][i] += ((touched >> j) & 1) *  sines[j].Process();
                out[1][i] = out[0][i];
            }
        }
	}
}

int main(void)
{

	hw.Init();
	hw.SetAudioBlockSize(16); 
    auto i2cconfig = Mpr121I2CTransport::Config();
    i2c.Init(i2cconfig);

    auto mprconfig = Mpr121I2C::Config();
    touch.Init(mprconfig);


    for (int i = 0; i < 12; i++)
    {
        sines[i].Init(48000);
        sines[i].SetFreq(110*(i+1));
        sines[i].SetAmp(0.085);
    }

	hw.SetAudioSampleRate(SaiHandle::Config::SampleRate::SAI_48KHZ);
	hw.StartAudio(AudioCallback);

	while(1) {
        touched = touch.Touched();
    }
}
